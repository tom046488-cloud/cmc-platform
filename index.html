<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CMC Fan Platform</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ========== RESET & GLOBAL ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        body {
            background: #0b141a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        /* ========== AUTH ========== */
        #auth-container {
            background: #1f2c34;
            border-radius: 24px;
            padding: 30px 24px;
            max-width: 400px;
            margin: 30px auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            text-align: center;
        }
        .auth-logo {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            border: 3px solid #8e44ad;
            margin-bottom: 20px;
            object-fit: cover;
        }
        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: #2a3942;
            border-radius: 40px;
            cursor: pointer;
            font-weight: 600;
            color: #8696a0;
            transition: 0.2s;
        }
        .auth-tab.active {
            background: #8e44ad;
            color: #fff;
        }
        .auth-form {
            display: none;
        }
        .auth-form.active {
            display: block;
        }
        input {
            width: 100%;
            padding: 14px 16px;
            margin: 8px 0;
            border: none;
            border-radius: 30px;
            background: #2a3942;
            color: white;
            font-size: 16px;
        }
        input::placeholder {
            color: #8696a0;
        }
        button {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 30px;
            background: #8e44ad;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        button:hover {
            background: #9b59b6;
        }
        #message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 16px;
        }
        /* ========== MAIN APP ========== */
        #mainApp {
            display: none;
            height: 100vh;
            flex-direction: column;
            background: #0b141a;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #1f2c34;
            border-bottom: 1px solid #2a3942;
        }
        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            font-size: 1.1rem;
        }
        .logo-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid #8e44ad;
        }
        .notification-wrapper {
            position: relative;
            display: inline-block;
        }
        #bellIcon {
            font-size: 1.4rem;
            cursor: pointer;
            color: #8696a0;
        }
        #bellIcon.has-notifications {
            color: #8e44ad;
        }
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #1f2c34;
        }
        #headerBal {
            margin-left: 8px;
            font-size: 0.9rem;
            color: #2ecc71;
            font-weight: bold;
        }
        .notification-dropdown {
            position: absolute;
            top: 45px;
            right: 0;
            width: 350px;
            background: #1f2c34;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #2a3942;
            z-index: 2000;
            display: none;
        }
        .notification-dropdown.active {
            display: block;
        }
        .notification-header {
            padding: 15px;
            border-bottom: 1px solid #2a3942;
            display: flex;
            justify-content: space-between;
        }
        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #2a3942;
            cursor: pointer;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }
        .notification-item.unread {
            background: #2a3942;
        }
        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .notification-content {
            flex: 1;
        }
        .notification-title {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .notification-message {
            font-size: 0.85rem;
            color: #aaa;
        }
        .notification-time {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }
        .notification-actions {
            display: flex;
            padding: 10px 15px;
            gap: 8px;
            border-top: 1px solid #2a3942;
        }
        .notification-actions button {
            flex: 1;
            padding: 8px;
            background: #2a3942;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: #1f2c34;
            padding: 8px 0;
            border-top: 1px solid #2a3942;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 100;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #8696a0;
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item.active {
            color: #8e44ad;
        }
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }
        .page {
            display: none;
            padding: 16px;
            overflow-y: auto;
            flex: 1;
            margin-bottom: 70px;
        }
        .page.active {
            display: block;
        }
        .card {
            background: #1f2c34;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .wallet-card {
            background: linear-gradient(135deg, #8e44ad, #3a1c71);
            text-align: center;
            padding: 30px 20px;
        }
        .balance-label {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        .balance-amount {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
        }
        .vip-badge {
            background: rgba(0,0,0,0.3);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: inline-block;
            border: 1px solid rgba(255,255,255,0.2);
        }
        /* Profile page styles */
        .profile-header {
            position: relative;
            margin-bottom: 20px;
        }
        .settings-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            color: #8696a0;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s;
            z-index: 10;
        }
        .settings-icon:hover {
            color: #8e44ad;
            background: rgba(255,255,255,0.1);
        }
        .settings-menu {
            position: absolute;
            top: 50px;
            right: 10px;
            background: #1f2c34;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid #2a3942;
            z-index: 100;
            display: none;
            min-width: 200px;
            overflow: hidden;
        }
        .settings-menu.active {
            display: block;
        }
        .settings-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #fff;
        }
        .settings-menu-item:hover {
            background: #2a3942;
        }
        .settings-menu-item i {
            width: 20px;
            color: #8e44ad;
        }
        .profile-pic-edit {
            position: relative;
            display: inline-block;
        }
        .profile-pic-edit img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #1f2c34;
            cursor: pointer;
        }
        .profile-pic-edit i {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #8e44ad;
            border-radius: 50%;
            padding: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        /* Celebrities grid */
        .celeb-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .celeb-card {
            background: #2a3942;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }
        .celeb-img {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #8e44ad;
            margin-bottom: 8px;
        }
        .celeb-name {
            font-size: 0.8rem;
            font-weight: 600;
        }
        /* Recent chats */
        .recent-chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #2a3942;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .recent-chat-item:hover {
            background: #3a4a54;
        }
        .recent-chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }
        .recent-chat-info {
            flex: 1;
        }
        .recent-chat-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .recent-chat-message {
            font-size: 0.85rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        .recent-chat-time {
            font-size: 0.7rem;
            color: #aaa;
        }
        .unread-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4d4d;
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            font-weight: bold;
        }
        /* Marketplace */
        .market-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .product-card {
            background: #2a3942;
            border-radius: 12px;
            overflow: hidden;
        }
        .product-img {
            height: 100px;
            background: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 2rem;
        }
        .product-info {
            padding: 10px;
        }
        .product-title {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .product-price {
            color: #2ecc71;
            font-weight: 800;
            margin: 5px 0;
        }
        .btn-buy {
            background: #8e44ad;
            border: none;
            color: white;
            padding: 8px;
            border-radius: 6px;
            width: 100%;
            cursor: pointer;
        }
        /* Posts */
        .posts-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding-bottom: 20px;
        }
        .post-card {
            background: #1f2c34;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid #2a3942;
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
        }
        .post-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .post-info {
            flex: 1;
        }
        .post-name {
            font-weight: 600;
        }
        .post-time {
            font-size: 0.75rem;
            color: #8696a0;
        }
        .post-media {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            background: #000;
        }
        .post-caption {
            padding: 15px;
            font-size: 0.95rem;
        }
        .post-actions {
            display: flex;
            gap: 20px;
            padding: 10px 15px 15px;
            border-top: 1px solid #2a3942;
        }
        .post-like, .post-comment {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: #8696a0;
        }
        .post-like.liked {
            color: #ff4d4d;
        }
        .comment-section {
            padding: 0 15px 15px;
            border-top: 1px solid #2a3942;
            background: #1a252f;
        }
        .comment-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .comment-item {
            display: flex;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #2a3942;
        }
        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .comment-content {
            flex: 1;
        }
        .comment-author {
            font-weight: 600;
            font-size: 0.85rem;
        }
        .comment-text {
            font-size: 0.9rem;
            margin: 2px 0;
        }
        .comment-time {
            font-size: 0.65rem;
            color: #8696a0;
        }
        .comment-input-area {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .comment-input {
            flex: 1;
            background: #2a3942;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
        }
        .comment-send {
            background: #8e44ad;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
        }
        /* Chat window (user) */
        .chat-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0b141a;
            z-index: 2000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .chat-background-video,
        .chat-background-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
        }
        .chat-background-video {
            display: none;
        }
        .chat-background-image {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease;
        }
        .chat-background-image.moving {
            animation: moveBackground 30s linear infinite;
        }
        @keyframes moveBackground {
            0% { transform: scale(1) translate(0, 0); }
            25% { transform: scale(1.03) translate(-0.5%, -0.5%); }
            50% { transform: scale(1.05) translate(-1%, 0.5%); }
            75% { transform: scale(1.03) translate(0.5%, 1%); }
            100% { transform: scale(1) translate(0, 0); }
        }
        .chat-header, .chat-messages, .chat-input-area {
            position: relative;
            z-index: 1;
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(31,44,52,0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .chat-header i {
            font-size: 1.5rem;
            cursor: pointer;
        }
        .chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        .message.sent {
            align-self: flex-end;
            background: #8e44ad;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            align-self: flex-start;
            background: #2a3942;
            color: white;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 0.65rem;
            opacity: 0.8;
            display: block;
            margin-top: 5px;
        }
        .chat-input-area {
            display: flex;
            padding: 15px;
            background: rgba(31,44,52,0.9);
            backdrop-filter: blur(10px);
            gap: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            padding: 12px;
            border-radius: 25px;
            color: white;
        }
        .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #8e44ad;
            color: white;
            border: none;
            cursor: pointer;
        }
        /* Admin full-screen chat window */
        .admin-chat-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0b141a;
            z-index: 3000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .admin-chat-header {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #1f2c34;
            border-bottom: 1px solid #8e44ad;
        }
        .admin-chat-header i {
            font-size: 1.5rem;
            cursor: pointer;
            margin-right: 15px;
        }
        .admin-chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .admin-chat-header span {
            flex: 1;
            font-weight: 600;
        }
        .admin-chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .admin-chat-message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            font-size: 0.95rem;
            word-wrap: break-word;
        }
        .admin-chat-message.sent {
            align-self: flex-end;
            background: #8e44ad;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .admin-chat-message.received {
            align-self: flex-start;
            background: #2a3942;
            color: white;
            border-bottom-left-radius: 4px;
        }
        .admin-chat-input-area {
            display: flex;
            padding: 15px;
            background: #1f2c34;
            gap: 10px;
            border-top: 1px solid #8e44ad;
        }
        .admin-chat-input {
            flex: 1;
            background: #2a3942;
            border: none;
            padding: 12px;
            border-radius: 25px;
            color: white;
        }
        .admin-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #8e44ad;
            color: white;
            border: none;
            cursor: pointer;
        }
        /* Wallpaper modal */
        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        .wallpaper-item {
            aspect-ratio: 16/9;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            background-size: cover;
            background-position: center;
            position: relative;
            background-color: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .wallpaper-item.selected {
            border-color: #8e44ad;
            transform: scale(1.02);
        }
        .wallpaper-item .preview-label {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            color: #fff;
        }
        .wallpaper-item.moving::after {
            content: "ðŸŽ¬";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1rem;
            background: rgba(0,0,0,0.5);
            padding: 2px 5px;
            border-radius: 4px;
        }
        /* Modal */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: #1f2c34;
            width: 100%;
            max-width: 550px;
            padding: 25px;
            border-radius: 20px;
            position: relative;
            border: 1px solid #8e44ad;
        }
        .close-modal {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
        }
        .input-box {
            width: 100%;
            padding: 12px;
            background: #2a3942;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            margin-bottom: 10px;
        }
        textarea.input-box {
            min-height: 80px;
            resize: vertical;
        }
        .gift-card-float {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 65px;
            height: 65px;
            background: linear-gradient(145deg, #ff9a44, #ff6b6b);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(255,107,107,0.6);
            z-index: 2600;
            cursor: pointer;
        }
        /* Spinner */
        .spinner-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #0b141a;
            z-index: 6000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(142,68,173,0.3);
            border-top: 5px solid #8e44ad;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #adminCelebForm {
            margin-top: 20px;
            padding: 15px;
            background: #2a3942;
            border-radius: 12px;
            display: none;
        }
        #adminCelebForm h4 {
            color: #8e44ad;
            margin-bottom: 10px;
        }
        /* Call modal */
        .call-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000dd;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .call-box {
            background: #1a1a2e;
            padding: 20px;
            border-radius: 20px;
            width: 95%;
            max-width: 400px;
            text-align: center;
            border: 2px solid #8e44ad;
            box-shadow: 0 0 30px rgba(142,68,173,0.5);
        }
        .call-avatar-container {
            margin: 15px 0;
            position: relative;
            display: inline-block;
        }
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #8e44ad;
        }
        .pulse-ring {
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            border: 3px solid transparent;
            animation: pulse 1.5s ease-out infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); border-color: #ff0000; box-shadow: 0 0 0 0 rgba(255,0,0,0.7); }
            25% { border-color: #ff7f00; }
            50% { transform: scale(1.05); border-color: #ffff00; box-shadow: 0 0 0 15px rgba(255,255,0,0); }
            75% { border-color: #00ff00; }
            100% { transform: scale(0.95); border-color: #0000ff; box-shadow: 0 0 0 0 rgba(0,0,255,0); }
        }
        .call-status {
            font-size: 1.2rem;
            margin: 10px 0;
            color: #fff;
            text-shadow: 0 0 10px #8e44ad;
        }
        .call-box video {
            width: 100%;
            max-height: 200px;
            background: black;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .call-buttons button {
            margin: 5px;
            padding: 8px 12px;
        }
        /* Support button */
        .support-chat-float {
            position: fixed;
            bottom: 180px;
            right: 20px;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
            background-size: 300% 300%;
            animation: rainbow 3s ease infinite;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.6);
            z-index: 2601;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .support-chat-float:hover {
            transform: scale(1.1);
        }
        .support-chat-float i {
            font-size: 2rem;
            color: white;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        /* Admin page styles */
        .admin-section {
            background: #1f2c34;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .admin-section h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #8e44ad;
            font-size: 1.1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-card {
            background: #2a3942;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
        }
        .stat-card .number {
            font-size: 2rem;
            font-weight: 800;
            color: #8e44ad;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }
        .admin-card {
            background: #2a3942;
            border-radius: 12px;
            padding: 12px;
            position: relative;
        }
        .admin-card.blocked {
            opacity: 0.6;
            background: #3a3a3a;
        }
        .admin-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
            border-radius: 20px;
            border: none;
            cursor: pointer;
        }
        .btn-primary-small {
            background: #8e44ad;
            color: white;
        }
        .btn-danger-small {
            background: #e74c3c;
            color: white;
        }
        .btn-warning-small {
            background: #f39c12;
            color: white;
        }
        .badge {
            background: #8e44ad;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            display: inline-block;
            margin-left: 5px;
        }
        .celeb-group {
            margin-bottom: 20px;
        }
        .celeb-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            background: rgba(142,68,173,0.2);
            border-radius: 30px;
        }
        .celeb-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        .celeb-header span {
            font-weight: 600;
            flex: 1;
        }
        .celeb-header i {
            transition: transform 0.2s;
        }
        .celeb-header.collapsed i {
            transform: rotate(-90deg);
        }
        .user-conversations {
            padding-left: 10px;
        }
        .fan-card {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #2a3942;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .fan-card img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }
        .fan-info {
            flex: 1;
        }
        .fan-info .name {
            font-weight: 600;
        }
        .fan-info .last-msg {
            font-size: 0.8rem;
            color: #aaa;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        .fan-info .time {
            font-size: 0.7rem;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Floating gift card button -->
    <div class="gift-card-float" onclick="openGiftStore()"><i class="fas fa-gift"></i><span>GIFT</span></div>

    <!-- Floating rainbow support button (only shown on Me page) -->
    <div class="support-chat-float" id="supportChatFloat" onclick="openAdminChat()">
        <i class="fas fa-headset"></i>
    </div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
        <div id="auth-container">
            <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" class="auth-logo" alt="CMC Logo">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="toggleAuth('login')">Login</div>
                <div class="auth-tab" onclick="toggleAuth('register')">Create Account</div>
            </div>
            <div id="loginForm" class="auth-form active">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="loginUser()">Log In</button>
            </div>
            <div id="registerForm" class="auth-form">
                <input type="text" id="regName" placeholder="Full Name">
                <input type="email" id="regEmail" placeholder="Email">
                <input type="password" id="regPassword" placeholder="Password">
                <button onclick="startRegistration()">Create Account</button>
            </div>
            <div id="message"></div>
        </div>
    </div>

    <!-- Spinner -->
    <div id="spinner" class="spinner-overlay">
        <div class="spinner"></div>
        <div id="spinnerText" style="margin-top:20px;">Loading...</div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="logo-area">
                <img src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" class="logo-img">
                <span>CMC Fan</span>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="notification-wrapper">
                    <i class="fas fa-bell" id="bellIcon"></i>
                    <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
                    <div id="notificationDropdown" class="notification-dropdown">
                        <div class="notification-header">
                            <h3>Notifications</h3>
                            <span id="notificationCount">0 new</span>
                        </div>
                        <div id="notificationList" class="notification-list"></div>
                        <div class="notification-actions">
                            <button onclick="markAllAsRead()">Mark All Read</button>
                            <button onclick="clearAllNotifications()">Clear All</button>
                        </div>
                    </div>
                </div>
                <span id="headerBal" style="margin-left:8px;">$0.00</span>
            </div>
        </div>

        <!-- PAGES (existing) -->
        <div id="home" class="page active">
            <div class="card wallet-card">
                <div class="balance-label">Total Balance</div>
                <div class="balance-amount" id="homeBalance">$0.00</div>
                <div class="vip-badge">VIP <span id="userVipLevel">1</span></div>
            </div>
            <h3>Active Celebrities</h3>
            <div style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px;" id="homeCelebList"></div>
            <div class="card" onclick="navTo('market')">
                <h3><i class="fas fa-store" style="color: #8e44ad;"></i> New Arrivals</h3>
                <p style="color:#aaa;">Private Meet Cards, Tickets & More available now!</p>
            </div>
        </div>

        <div id="celebs" class="page">
            <input type="text" class="input-box" id="searchCelebs" placeholder="Search Celebrities...">
            <div id="allCelebGrid" class="celeb-grid"></div>
            <div id="adminCelebForm" style="display:none;">
                <h4>Add Celebrity (Admin)</h4>
                <input type="text" id="newCelebName" class="input-box" placeholder="Name">
                <input type="url" id="newCelebImg" class="input-box" placeholder="Image URL">
                <button onclick="addCelebrity()">Add Celebrity</button>
            </div>
        </div>

        <div id="market" class="page">
            <h3>Celebrity Marketplace</h3>
            <div class="market-grid" id="productsGrid"></div>
        </div>

        <div id="chat" class="page">
            <h3>Community Chat</h3>
            <input type="text" class="input-box" id="searchUsers" placeholder="Find friends...">
            <div id="userList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="recent" class="page">
            <h3>Recent Chats</h3>
            <div id="recentChatsList" style="display: flex; flex-direction: column; gap: 10px;"></div>
        </div>

        <div id="posts" class="page">
            <h3>Posts</h3>
            <div id="postsFeed" class="posts-feed"></div>
        </div>

        <div id="wallet" class="page">
            <div class="card wallet-card">
                <div class="balance-label">Available Funds</div>
                <div class="balance-amount" id="walletBalance">$0.00</div>
            </div>
            <button class="action-btn btn-deposit" onclick="openDepositModal()"><i class="fas fa-plus-circle"></i> Deposit</button>
            <button class="action-btn btn-withdraw" onclick="attemptWithdrawal()"><i class="fas fa-university"></i> Withdraw</button>
        </div>

        <div id="profile" class="page">
            <div class="profile-header">
                <i class="fas fa-cog settings-icon" onclick="toggleSettingsMenu()"></i>
                <div class="settings-menu" id="settingsMenu">
                    <div class="settings-menu-item" onclick="openChangeNameModal()">
                        <i class="fas fa-user-edit"></i>
                        <span>Change Name</span>
                    </div>
                    <div class="settings-menu-item" onclick="openWallpaperModal()">
                        <i class="fas fa-image"></i>
                        <span>Change Chat Wallpaper</span>
                    </div>
                </div>
            </div>
            <div style="text-align: center;">
                <div class="profile-pic-edit">
                    <img id="profileAvatar" src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png" onclick="openAvatarModal()">
                    <i class="fas fa-camera" onclick="openAvatarModal()"></i>
                </div>
                <h2 id="profileName">Loading...</h2>
                <div class="vip-badge">Verified Member</div>
            </div>
            <button class="upload-post-btn" id="uploadPostBtn"><i class="fas fa-plus-circle"></i> Create Post</button>
            <button class="action-btn" onclick="logout()" style="background:#333;">Log Out</button>
        </div>

        <!-- NEW ADMIN PAGE (only visible to admin) -->
        <div id="admin" class="page">
            <!-- Sub-navigation for admin sections -->
            <div style="display: flex; gap: 5px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px;">
                <button class="btn-small btn-primary-small" onclick="showAdminSection('dashboard')">Dashboard</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('users')">Users</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('posts')">Posts</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('celebs')">Celebrities</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('products')">Products</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('fanchats')">Fan Chats</button>
                <button class="btn-small btn-primary-small" onclick="showAdminSection('settings')">Settings</button>
            </div>

            <!-- Admin Dashboard Section -->
            <div id="adminDashboard" class="admin-section" style="display:block;">
                <h3><i class="fas fa-tachometer-alt"></i> Overview</h3>
                <div class="stats-grid">
                    <div class="stat-card"><span class="number" id="statUsers">0</span><br>Users</div>
                    <div class="stat-card"><span class="number" id="statPosts">0</span><br>Posts</div>
                    <div class="stat-card"><span class="number" id="statCelebs">0</span><br>Celebrities</div>
                    <div class="stat-card"><span class="number" id="statProducts">0</span><br>Products</div>
                </div>
            </div>

            <!-- Admin Users Section -->
            <div id="adminUsers" class="admin-section" style="display:none;">
                <h3><i class="fas fa-users"></i> Manage Users</h3>
                <input type="text" id="adminSearchUsers" class="input-box" placeholder="Search by name or email...">
                <div id="adminUsersList" class="admin-grid"></div>
            </div>

            <!-- Admin Posts Section -->
            <div id="adminPosts" class="admin-section" style="display:none;">
                <h3><i class="fas fa-newspaper"></i> Manage Posts</h3>
                <div id="adminPostsList" class="admin-grid"></div>
            </div>

            <!-- Admin Celebrities Section -->
            <div id="adminCelebs" class="admin-section" style="display:none;">
                <h3><i class="fas fa-star"></i> Manage Celebrities</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="adminCelebName" class="input-box" placeholder="Name">
                    <input type="url" id="adminCelebImg" class="input-box" placeholder="Image URL">
                    <button onclick="adminAddCelebrity()" style="width:auto;">Add</button>
                </div>
                <div id="adminCelebsList" class="admin-grid"></div>
            </div>

            <!-- Admin Products Section -->
            <div id="adminProducts" class="admin-section" style="display:none;">
                <h3><i class="fas fa-shopping-cart"></i> Manage Products</h3>
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <input type="text" id="adminProductName" class="input-box" placeholder="Name">
                    <input type="number" id="adminProductPrice" class="input-box" placeholder="Price">
                    <input type="text" id="adminProductIcon" class="input-box" placeholder="Icon (e.g., 'box')" value="box">
                    <button onclick="adminAddProduct()" style="width:auto;">Add</button>
                </div>
                <div id="adminProductsList" class="admin-grid"></div>
            </div>

            <!-- Admin Fan Chats Section -->
            <div id="adminFanChats" class="admin-section" style="display:none;">
                <h3><i class="fas fa-heart"></i> Fan Conversations</h3>
                <div id="fanChatsContainer"></div>
            </div>

            <!-- Admin Settings Section -->
            <div id="adminSettings" class="admin-section" style="display:none;">
                <h3><i class="fas fa-bullhorn"></i> Notifications</h3>
                <select id="notifyTarget" class="input-box">
                    <option value="all">All Users</option>
                    <option value="user">Specific User</option>
                </select>
                <input type="text" id="notifyUserId" class="input-box" placeholder="User ID (if specific)" style="display:none;">
                <input type="text" id="notifyTitle" class="input-box" placeholder="Title">
                <textarea id="notifyMessage" class="input-box" placeholder="Message"></textarea>
                <input type="text" id="notifyLink" class="input-box" placeholder="Link (optional)">
                <button onclick="sendNotification()">Send Notification</button>

                <h3 style="margin-top:20px;"><i class="fas fa-music"></i> Global Music</h3>
                <div style="display: flex; gap: 10px;">
                    <input type="url" id="musicUrl" class="input-box" placeholder="Music URL (mp3)">
                    <button onclick="setMusicUrl()" style="width:auto;">Set</button>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation (will show Admin item conditionally) -->
        <div class="bottom-nav" id="bottomNav">
            <div class="nav-item active" onclick="navTo('home', this)"><i class="fas fa-home"></i>Home</div>
            <div class="nav-item" onclick="navTo('market', this)"><i class="fas fa-store"></i>Shop</div>
            <div class="nav-item" onclick="navTo('celebs', this)"><i class="fas fa-star"></i>Stars</div>
            <div class="nav-item" onclick="navTo('chat', this)"><i class="fas fa-comment-dots"></i>Chat</div>
            <div class="nav-item" onclick="navTo('recent', this)"><i class="fas fa-history"></i>Recent</div>
            <div class="nav-item" onclick="navTo('posts', this)"><i class="fas fa-rss"></i>Posts</div>
            <div class="nav-item" onclick="navTo('wallet', this)"><i class="fas fa-wallet"></i>Wallet</div>
            <div class="nav-item" onclick="navTo('profile', this)"><i class="fas fa-user"></i>Me</div>
            <!-- Admin item will be inserted here dynamically if user is admin -->
        </div>
    </div>

    <!-- CHAT WINDOW (user) -->
    <div id="chatInterface" class="chat-window">
        <video id="chatVideo" class="chat-background-video" loop muted playsinline preload="auto"></video>
        <div id="chatImageBg" class="chat-background-image"></div>
        <div class="chat-header">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <img id="chatAvatar" src="">
            <div style="flex:1;"><span id="chatName"></span><div style="font-size:0.75rem; color:#2ecc71;">Online</div></div>
            <!-- Call buttons (hidden by default) -->
            <div id="callButtons" style="display: none; gap: 10px; margin-right: 10px;">
                <button id="audioCallBtn" style="background: none; border: none; color: #8e44ad; font-size: 1.2rem; cursor: pointer;">ðŸ“ž</button>
                <button id="videoCallBtn" style="background: none; border: none; color: #8e44ad; font-size: 1.2rem; cursor: pointer;">ðŸŽ¥</button>
            </div>
        </div>
        <div id="messageContainer" class="chat-messages"></div>
        <div class="chat-input-area">
            <input type="text" id="msgInput" class="chat-input" placeholder="Type message...">
            <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- ADMIN FULL-SCREEN CHAT WINDOW (for replying to fans) -->
    <div id="adminChatWindow" class="admin-chat-window">
        <div class="admin-chat-header">
            <i class="fas fa-arrow-left" onclick="closeAdminChatWindow()"></i>
            <img id="adminChatAvatar" src="" alt="avatar">
            <span id="adminChatTitle">Chat</span>
        </div>
        <div id="adminChatMessages" class="admin-chat-messages"></div>
        <div class="admin-chat-input-area">
            <input type="text" id="adminChatInput" class="admin-chat-input" placeholder="Type message...">
            <button class="admin-send-btn" onclick="sendAdminChatMessage()"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- POST UPLOAD MODAL -->
    <div id="postUploadModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('postUploadModal').style.display='none'">&times;</span>
            <h3>Create Post</h3>
            <textarea id="postCaption" class="input-box" placeholder="Write something..."></textarea>
            <input type="file" id="postFile" accept="image/*,video/*" class="input-box">
            <div id="postUploadStatus" style="margin-bottom:10px;"></div>
            <button class="action-btn btn-primary" onclick="uploadPost()">Post</button>
        </div>
    </div>

    <!-- OTHER MODALS -->
    <div id="avatarModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('avatarModal').style.display='none'">&times;</span>
            <h3>Change Profile Picture</h3>
            <input type="file" id="avatarFileInput" accept="image/*" class="input-box">
            <button class="action-btn btn-primary" onclick="uploadAvatar()">Upload</button>
            <div id="avatarUploadStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="changeNameModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('changeNameModal').style.display='none'">&times;</span>
            <h3>Change Display Name</h3>
            <input type="text" id="newNameInput" class="input-box" placeholder="Enter new name">
            <button class="action-btn btn-primary" onclick="updateDisplayName()">Update Name</button>
            <div id="nameUpdateStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="wallpaperModal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <span class="close-modal" onclick="document.getElementById('wallpaperModal').style.display='none'">&times;</span>
            <h3>Choose Chat Wallpaper</h3>
            <p style="color:#aaa; margin-bottom:10px;">Select a wallpaper for your chat background</p>
            <div class="wallpaper-grid" id="wallpaperGrid"></div>
            <button class="action-btn btn-primary" onclick="saveWallpaper()">Apply Wallpaper</button>
            <div id="wallpaperStatus" style="margin-top:10px;"></div>
        </div>
    </div>

    <div id="giftStoreModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('giftStoreModal').style.display='none'">&times;</span>
            <h2 style="color:#f1c40f;">Gift Card Store</h2>
            <p style="color:#aaa;">Coming soon!</p>
        </div>
    </div>

    <div id="depositModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('depositModal').style.display='none'">&times;</span>
            <h3>Deposit</h3>
            <p style="color:#aaa;">Send BTC to: bc1qm3mfz4ytpkthcdcl0fep3ndzq2g3jxme4de05p</p>
            <button class="action-btn" onclick="copyAddress()">Copy Address</button>
        </div>
    </div>

    <div id="withdrawModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('withdrawModal').style.display='none'">&times;</span>
            <h3>Withdraw</h3>
            <p style="color:#aaa;">VIP 4+ required</p>
            <input type="number" id="withdrawAmount" class="input-box" placeholder="Amount">
            <input type="text" id="withdrawAddress" class="input-box" placeholder="Address">
            <button class="action-btn btn-primary" onclick="submitWithdrawal()">Request</button>
        </div>
    </div>

    <div id="buyModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('buyModal').style.display='none'">&times;</span>
            <h3>Checkout</h3>
            <p id="buyProductName"></p>
            <input type="text" id="shipAddress" class="input-box" placeholder="Address">
            <input type="text" id="shipPhone" class="input-box" placeholder="Phone">
            <button class="action-btn btn-primary" onclick="processPurchase()">Confirm</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content" style="background: linear-gradient(135deg,#c0392b,#8e44ad); color:white;">
            <i class="fas fa-check-circle" style="font-size:3rem;"></i>
            <h2>Purchase Successful!</h2>
            <p>Tracking Code:</p>
            <div id="finalTrackingCode" style="background:rgba(0,0,0,0.3); padding:10px;"></div>
            <button class="action-btn" onclick="document.getElementById('successModal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- CALL MODAL -->
    <div id="callModal" class="call-modal" style="display:none;">
        <div class="call-box">
            <div id="callAvatarContainer" class="call-avatar-container">
                <img id="callAvatarImg" class="call-avatar" src="https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png">
                <div id="callPulseRing" class="pulse-ring"></div>
            </div>
            <div id="callStatus" class="call-status">Connecting...</div>
            <video id="localVideo" autoplay playsinline muted style="display:none;"></video>
            <video id="remoteVideo" autoplay playsinline style="display:none;"></video>
            <div class="call-buttons">
                <button id="acceptCallBtn">Accept</button>
                <button id="rejectCallBtn">Reject</button>
                <button id="endCallBtn">End</button>
            </div>
        </div>
    </div>

    <script type="module">
        // ========== FIREBASE ==========
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, updateDoc, onSnapshot, orderBy, serverTimestamp, addDoc, increment, deleteDoc, writeBatch, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';
        import Toastify from 'https://cdn.jsdelivr.net/npm/toastify-js/src/toastify-es.js';

        console.log("Firebase modules loaded");

        const firebaseConfig = {
            apiKey: "AIzaSyDvSEbNwMZJeE7WXrUvjclmSpeDyTjqLzw",
            authDomain: "fully-understand.firebaseapp.com",
            projectId: "fully-understand",
            storageBucket: "fully-understand.firebasestorage.app",
            messagingSenderId: "372305817292",
            appId: "1:372305817292:web:795d8def6932874df09c69"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log("Firebase initialized");

        const CLOUD_NAME = 'dnkll2fha';
        const UPLOAD_PRESET = 'my_website_design';
        const ADMIN_EMAIL = "moxxxtiox@gmail.com";

        // ========== WALLPAPERS ==========
        const wallpapers = [
            { id: 'moving1', name: 'Moving Waves 1', url: 'https://premier-gold-wthio10a6v.edgeone.app/moving%20walaksb.mp4', moving: true },
            { id: 'moving2', name: 'Moving Waves 2', url: 'https://colourful-violet-jqpqyp5emd.edgeone.app/moving%20sggsgs.mp4', moving: true },
            { id: 'moving3', name: 'Moving Waves 3', url: 'https://parliamentary-coral-phidn8dyzg.edgeone.app/moving%20whevejd.mp4', moving: true },
            { id: 'moving4', name: 'Moving Waves 4', url: 'https://worthy-orange-z8l14p8cm6.edgeone.app/moving%20walsnsn.mp4', moving: true },
            { id: 'moving5', name: 'Video Guru 1', url: 'https://marginal-lime-nng2c9cp9c.edgeone.app/Video.Guru_20260219_171036307.mp4', moving: true },
            { id: 'moving6', name: 'Video Guru 2', url: 'https://unaware-plum-g4qh9rcxuh.edgeone.app/Video.Guru_20260219_172003785.mp4', moving: true },
            { id: 'moving7', name: 'Moving AGSH', url: 'https://husky-lime-nrtzwo5pqd.edgeone.app/moving%20wallpaper%20agsh.mp4', moving: true },
            { id: 'moving8', name: 'Moving AA', url: 'https://adorable-blush-gwojhzc0sx.edgeone.app/moving%20wallpaper%20aa.mp4', moving: true },
            { id: 'static1', name: 'Purple Abstract', url: 'https://furious-peach-wlmhvgxcob.edgeone.app/images%20-%202026-02-19T160551.567.jpeg', moving: false },
            { id: 'static2', name: 'Blue Abstract', url: 'https://average-harlequin-e4re4mwodq.edgeone.app/images%20-%202026-02-19T160543.856.jpeg', moving: false },
            { id: 'static3', name: 'Sunset Mountains', url: 'https://i.ibb.co/yF4NS12s/images-2026-02-19-T160448-732.jpg', moving: false },
            { id: 'static4', name: 'Forest Path', url: 'https://i.ibb.co/fGD3FNV1/images-2026-02-19-T160430-065.jpg', moving: false },
            { id: 'static5', name: 'Ocean Waves', url: 'https://i.ibb.co/FbQ4wpqR/images-2026-02-19-T160344-114.jpg', moving: false },
            { id: 'static6', name: 'Abstract Art', url: 'https://i.ibb.co/KpX2hZBV/71-T8m-Z3u-HL.jpg', moving: false },
            { id: 'static7', name: '3D Wallpaper', url: 'https://i.ibb.co/VnNfjRB/3d-walpaper.jpg', moving: false },
            { id: 'static8', name: 'Live Wallpaper', url: 'https://i.ibb.co/1BwNFRW/live-walpaper.jpg', moving: false },
            { id: 'static9', name: 'Porsche AI', url: 'https://i.ibb.co/5xKL6h2X/porsch-a-i.png', moving: false },
            { id: 'static10', name: 'Indigenous Person 1', url: 'https://i.ibb.co/4ZjTwg1J/portrait-3d-cartoon-indigenous-person-1.jpg', moving: false },
            { id: 'static11', name: 'Indigenous Person 2', url: 'https://i.ibb.co/C5Y8qg8r/portrait-3d-cartoon-indigenous-person.jpg', moving: false },
            { id: 'static12', name: 'Karola G', url: 'https://i.ibb.co/MxS184g9/pexels-karola-g-5713581.jpg', moving: false },
            { id: 'static13', name: 'Alien World 3', url: 'https://i.ibb.co/sY8CWxR/cheerful-3d-alien-world-3.jpg', moving: false },
            { id: 'static14', name: 'Isolated House', url: 'https://i.ibb.co/RTFwFzRd/digital-art-isolated-house-1.jpg', moving: false },
            { id: 'static15', name: 'Fantasy Lamp', url: 'https://i.ibb.co/Xxy4z8vj/lamp-with-fantasy-futuristic-design.jpg', moving: false },
            { id: 'static16', name: 'Shiny Bubbles', url: 'https://i.ibb.co/6cpY4XNd/shiny-bubbles-wallpaper.jpg', moving: false },
            { id: 'static17', name: 'Alien World 1', url: 'https://i.ibb.co/sdj8WfWJ/cheerful-3d-alien-world-1.jpg', moving: false },
            { id: 'static18', name: 'Alien World', url: 'https://i.ibb.co/pBjCVVbg/cheerful-3d-alien-world.jpg', moving: false },
            { id: 'static19', name: 'Astronaut Diving', url: 'https://i.ibb.co/5WNBTwz2/astronaut-diving-digital-art.jpg', moving: false },
            { id: 'static20', name: 'Alien World 2', url: 'https://i.ibb.co/wNzDw6Fc/cheerful-3d-alien-world-2.jpg', moving: false },
            { id: 'static21', name: 'Cute Animals Christmas', url: 'https://i.ibb.co/G4mYkfFZ/3d-cute-animals-christmas.jpg', moving: false },
            { id: 'static22', name: 'Half Robot Tiger', url: 'https://i.ibb.co/kgBffwrh/futuristic-half-robot-tiger-nature-1.jpg', moving: false }
        ];

        let selectedWallpaper = wallpapers.find(w => w.id === 'static17') || wallpapers[0];
        const preloadedVideos = new Map();

        function preloadWallpapers() {
            const toPreload = wallpapers.slice(0, 10);
            toPreload.forEach(w => {
                if (w.moving) {
                    const video = document.createElement('video');
                    video.src = w.url;
                    video.preload = 'auto';
                    video.muted = true;
                    video.playsInline = true;
                    video.style.display = 'none';
                    document.body.appendChild(video);
                    video.load();
                    preloadedVideos.set(w.url, video);
                } else {
                    const img = new Image();
                    img.src = w.url;
                }
            });
        }

        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let currentUserData = null;
        let currentChatId = null;
        let currentChatPartner = null;
        let chatUnsubscribe = null;
        let selectedProduct = null;
        let isCelebChat = false;
        let notificationsUnsubscribe = null;
        let unreadCount = 0;
        let recentChatsUnsubscribe = null;
        let postsUnsubscribe = null;
        let commentUnsubscribes = new Map();

        // Admin data
        let adminUserData = null;
        let users = [], posts = [], celebs = [], products = [], fanMessages = [];

        const defaultAvatar = 'https://i.ibb.co/gZqjS62p/Gemini-Generated-Image-lh3nyulh3nyulh3n.png';

        // ========== UTILITY ==========
        function formatTimeAgo(timestamp) {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        function updateBalanceDisplay() {
            const bal = currentUserData?.balance || 0;
            document.getElementById('homeBalance').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('walletBalance').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('headerBal').innerText = `$${bal.toFixed(2)}`;
        }

        // ========== AUTH ==========
        window.toggleAuth = function(form) {
            document.getElementById('loginForm').style.display = form === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = form === 'register' ? 'block' : 'none';
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
        };

        window.startRegistration = async function() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPassword').value;
            if (!name || !email || !pass) return Toastify({ text: "Fill all fields" }).showToast();
            document.getElementById('spinner').style.display = 'flex';
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, 'users', cred.user.uid), {
                    fullName: name,
                    email,
                    balance: 0,
                    vipLevel: 1,
                    avatar: defaultAvatar,
                    wallpaper: 'static17',
                    uploadCount: 0,
                    lastUploadDate: ''
                });
                Toastify({ text: "Account created", backgroundColor: "green" }).showToast();
            } catch (e) {
                console.error("Registration error:", e);
                Toastify({ text: e.message, backgroundColor: "#e74c3c" }).showToast();
            }
            document.getElementById('spinner').style.display = 'none';
        };

        window.loginUser = async function() {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPassword').value;
            if (!email || !pass) return Toastify({ text: "Enter email and password" }).showToast();
            document.getElementById('spinner').style.display = 'flex';
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                console.error("Login error:", e);
                Toastify({ text: e.message, backgroundColor: "#e74c3c" }).showToast();
            }
            document.getElementById('spinner').style.display = 'none';
        };

        window.logout = () => signOut(auth);

        // ========== WALLPAPER FUNCTIONS ==========
        function renderWallpaperGrid() {
            const grid = document.getElementById('wallpaperGrid');
            if (!grid) return;
            grid.innerHTML = wallpapers.map(w => {
                const isSelected = selectedWallpaper && selectedWallpaper.id === w.id;
                return `
                    <div class="wallpaper-item ${isSelected ? 'selected' : ''} ${w.moving ? 'moving' : ''}" 
                         onclick="selectWallpaper('${w.id}')"
                         style="background-image: url('${w.moving ? '' : w.url}'); background-color: ${w.moving ? '#2a3942' : 'transparent'};">
                        ${w.moving ? '<i class="fas fa-video" style="font-size:2rem; color:#8e44ad;"></i>' : ''}
                        <span class="preview-label">${w.name}</span>
                    </div>
                `;
            }).join('');
        }

        window.selectWallpaper = function(id) {
            selectedWallpaper = wallpapers.find(w => w.id === id) || wallpapers[0];
            renderWallpaperGrid();
        };

        window.openWallpaperModal = function() {
            document.getElementById('settingsMenu').classList.remove('active');
            const savedId = currentUserData?.wallpaper || 'static17';
            selectedWallpaper = wallpapers.find(w => w.id === savedId) || wallpapers.find(w => w.id === 'static17') || wallpapers[0];
            renderWallpaperGrid();
            document.getElementById('wallpaperModal').style.display = 'flex';
            document.getElementById('wallpaperStatus').textContent = '';
        };

        window.saveWallpaper = async function() {
            const status = document.getElementById('wallpaperStatus');
            status.textContent = 'Saving...';
            status.style.color = '#8e44ad';
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { wallpaper: selectedWallpaper.id });
                currentUserData.wallpaper = selectedWallpaper.id;
                document.getElementById('wallpaperModal').style.display = 'none';
                Toastify({ text: "Wallpaper updated!" }).showToast();
            } catch (e) {
                console.error("Save wallpaper error:", e);
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        };

        function applyChatWallpaper() {
            const videoEl = document.getElementById('chatVideo');
            const imageEl = document.getElementById('chatImageBg');
            if (!videoEl || !imageEl) return;
            const wallpaperId = currentUserData?.wallpaper || 'static17';
            const wallpaper = wallpapers.find(w => w.id === wallpaperId) || wallpapers.find(w => w.id === 'static17') || wallpapers[0];
            
            if (wallpaper.moving) {
                videoEl.style.display = 'block';
                imageEl.style.display = 'none';
                videoEl.src = wallpaper.url;
                videoEl.load();
                videoEl.play().catch(e => console.log('Video play error', e));
            } else {
                videoEl.style.display = 'none';
                videoEl.pause();
                imageEl.style.display = 'block';
                imageEl.style.backgroundImage = `url('${wallpaper.url}')`;
                imageEl.classList.add('moving');
            }
        }

        // ========== SETTINGS MENU ==========
        window.toggleSettingsMenu = function() {
            const menu = document.getElementById('settingsMenu');
            menu.classList.toggle('active');
        };

        document.addEventListener('click', function(event) {
            const menu = document.getElementById('settingsMenu');
            const icon = document.querySelector('.settings-icon');
            if (menu && icon && !menu.contains(event.target) && !icon.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // ========== CHANGE NAME ==========
        window.openChangeNameModal = function() {
            document.getElementById('settingsMenu').classList.remove('active');
            document.getElementById('changeNameModal').style.display = 'flex';
            document.getElementById('newNameInput').value = currentUserData?.fullName || '';
            document.getElementById('nameUpdateStatus').textContent = '';
        };

        window.updateDisplayName = async function() {
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                document.getElementById('nameUpdateStatus').textContent = 'Please enter a name';
                document.getElementById('nameUpdateStatus').style.color = '#ff6b6b';
                return;
            }
            const status = document.getElementById('nameUpdateStatus');
            status.textContent = 'Updating...';
            status.style.color = '#8e44ad';
            try {
                await updateDoc(doc(db, 'users', currentUser.uid), { fullName: newName });
                currentUserData.fullName = newName;
                document.getElementById('profileName').textContent = newName;
                document.getElementById('changeNameModal').style.display = 'none';
                Toastify({ text: "Name updated successfully!", backgroundColor: "green" }).showToast();
            } catch (e) {
                console.error("Name update error:", e);
                status.textContent = 'Error: ' + e.message;
                status.style.color = '#ff6b6b';
            }
        };

        // ========== NOTIFICATIONS ==========
        function loadNotifications() {
            if (!currentUser) return;
            if (notificationsUnsubscribe) notificationsUnsubscribe();

            const q = query(
                collection(db, 'notifications'),
                where('userId', '==', currentUser.uid)
            );

            notificationsUnsubscribe = onSnapshot(q, (snap) => {
                const notifs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                notifs.sort((a, b) => (b.timestamp?.toDate?.() || 0) - (a.timestamp?.toDate?.() || 0));
                unreadCount = notifs.filter(n => !n.read).length;
                updateNotificationUI(notifs);
            }, (error) => {
                console.error('Notifications listener error:', error);
            });
        }

        function updateNotificationUI(notifs) {
            const badge = document.getElementById('notificationBadge');
            const bell = document.getElementById('bellIcon');
            const cnt = document.getElementById('notificationCount');
            badge.style.display = unreadCount ? 'flex' : 'none';
            badge.textContent = unreadCount;
            if (unreadCount > 0) bell.classList.add('has-notifications');
            else bell.classList.remove('has-notifications');
            cnt.innerText = unreadCount + ' new';
            const list = document.getElementById('notificationList');
            if (!notifs.length) {
                list.innerHTML = '<div class="notification-empty">No notifications</div>';
                return;
            }
            list.innerHTML = notifs.map(n => {
                const title = n.title || 'Notification';
                const message = n.message || '';
                const from = n.from || 'System';
                const avatar = n.avatar || defaultAvatar;
                const time = n.timestamp ? formatTimeAgo(n.timestamp) : '';
                const link = n.link || '';
                return `
                    <div class="notification-item ${n.read ? '' : 'unread'}" onclick="openNotification('${n.id}', '${link}')">
                        <img src="${avatar}" class="notification-avatar" onerror="this.src='${defaultAvatar}'">
                        <div class="notification-content">
                            <div class="notification-title">${title}</div>
                            <div class="notification-message">${message}</div>
                            <div class="notification-time">${time} â€¢ From: ${from}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.openNotification = async (id, link) => {
            await updateDoc(doc(db, 'notifications', id), { read: true });
            document.getElementById('notificationDropdown').classList.remove('active');
            if (link) {
                const parts = link.split('|');
                if (parts[0] === 'celeb') {
                    openCelebChat(parts[1], parts[2]);
                } else if (parts[0] === 'user') {
                    openUserChat(parts[1], parts[2], parts[3]);
                }
            }
        };

        window.markAllAsRead = async () => {
            const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid), where('read', '==', false));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.docs.forEach(d => batch.update(d.ref, { read: true }));
            await batch.commit();
        };

        window.clearAllNotifications = async () => {
            if (!confirm('Delete all notifications?')) return;
            const q = query(collection(db, 'notifications'), where('userId', '==', currentUser.uid));
            const snap = await getDocs(q);
            const batch = writeBatch(db);
            snap.docs.forEach(d => batch.delete(d.ref));
            await batch.commit();
        };

        window.toggleNotificationDropdown = () => {
            const d = document.getElementById('notificationDropdown');
            d.classList.toggle('active');
        };

        // ========== RECENT CHATS ==========
        function loadRecentChats() {
            if (!currentUser) return;
            if (recentChatsUnsubscribe) recentChatsUnsubscribe();
            const q = query(
                collection(db, 'userChats', currentUser.uid, 'chats'),
                orderBy('lastTimestamp', 'desc')
            );
            recentChatsUnsubscribe = onSnapshot(q, (snapshot) => {
                const list = document.getElementById('recentChatsList');
                if (!list) return;
                if (snapshot.empty) {
                    list.innerHTML = '<div class="notification-empty"><i class="fas fa-comments"></i><p>No recent chats</p></div>';
                    return;
                }
                let html = '';
                snapshot.forEach(docSnap => {
                    const chat = docSnap.data();
                    const chatId = docSnap.id;
                    const unread = chat.unreadCount || 0;
                    const timeAgo = formatTimeAgo(chat.lastTimestamp);
                    const lastMsg = chat.lastMessage || 'Tap to start chatting';
                    html += `
                        <div class="recent-chat-item" onclick="openChatFromRecent('${chatId}', '${chat.partnerName}', '${chat.partnerAvatar}', ${chat.isCeleb}, '${chat.partnerId}')">
                            <img src="${chat.partnerAvatar}" class="recent-chat-avatar" onerror="this.src='${defaultAvatar}'">
                            <div class="recent-chat-info">
                                <div class="recent-chat-name">${chat.partnerName}</div>
                                <div class="recent-chat-message">${lastMsg}</div>
                            </div>
                            <div class="recent-chat-time">${timeAgo}</div>
                            ${unread > 0 ? `<span class="unread-badge">${unread}</span>` : ''}
                        </div>
                    `;
                });
                list.innerHTML = html;
            }, (error) => {
                console.error('Recent chats listener error:', error);
            });
        }

        window.openChatFromRecent = function(chatId, name, avatar, isCeleb, partnerId) {
            updateDoc(doc(db, 'userChats', currentUser.uid, 'chats', chatId), { unreadCount: 0 });
            if (isCeleb) {
                openCelebChat(name, avatar);
            } else {
                openUserChat(name, avatar, partnerId);
            }
        };

        // ========== LOAD CELEBRITIES ==========
        async function loadCelebrities() {
            const q = query(collection(db, 'celebrities'));
            const snap = await getDocs(q);
            celebrities = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderCelebs();
        }

        // ========== ADMIN ADD CELEBRITY (for the small form on celebs page) ==========
        window.addCelebrity = async function() {
            const name = document.getElementById('newCelebName').value.trim();
            const img = document.getElementById('newCelebImg').value.trim();
            if (!name || !img) return Toastify({ text: "Enter name and image URL" }).showToast();
            await addDoc(collection(db, 'celebrities'), { name, img });
            document.getElementById('newCelebName').value = '';
            document.getElementById('newCelebImg').value = '';
            loadCelebrities();
            Toastify({ text: "Celebrity added" }).showToast();
        };

        function renderCelebs() {
            const grid = document.getElementById('allCelebGrid');
            const home = document.getElementById('homeCelebList');
            if (!grid || !home) return;
            grid.innerHTML = celebrities.map(c => `<div class="celeb-card" onclick="openCelebChat('${c.name}', '${c.img}')"><img src="${c.img}" class="celeb-img" onerror="this.src='${defaultAvatar}'"><div class="celeb-name">${c.name} <i class="fas fa-check-circle verified-badge"></i></div></div>`).join('');
            home.innerHTML = celebrities.slice(0, 8).map(c => `<div class="celeb-card" onclick="openCelebChat('${c.name}', '${c.img}')"><img src="${c.img}" class="celeb-img" onerror="this.src='${defaultAvatar}'"><div class="celeb-name">${c.name}</div></div>`).join('');
        }

        // ========== USERS ==========
        function loadUsers() {
            const q = query(collection(db, 'users'));
            onSnapshot(q, (snap) => {
                users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                const list = document.getElementById('userList');
                if (!list) return;
                list.innerHTML = users.filter(d => d.id !== currentUser.uid).map(u => `
                    <div class="celeb-card" style="display:flex; align-items:center; gap:15px; text-align:left; padding:15px; cursor:pointer;" onclick="openUserChat('${u.fullName}', '${u.avatar}', '${u.id}')">
                        <img src="${u.avatar}" style="width:50px; height:50px; border-radius:50%;" onerror="this.src='${defaultAvatar}'">
                        <div style="flex:1;"><div style="font-weight:600;">${u.fullName}</div><div style="font-size:0.8rem; color:#aaa;">VIP ${u.vipLevel}</div></div>
                        <i class="fas fa-comment-dots" style="color:#8e44ad;"></i>
                    </div>
                `).join('');
            });
        }

        // ========== CHAT OPENERS ==========
        window.openCelebChat = function(name, avatar) {
            isCelebChat = true;
            openChat(name, avatar, null, true);
        };

        window.openUserChat = function(name, avatar, uid) {
            isCelebChat = false;
            openChat(name, avatar, uid, false);
        };

        function openChat(name, avatar, uid, isCeleb) {
            document.getElementById('chatName').innerText = name;
            document.getElementById('chatAvatar').src = avatar;
            document.getElementById('chatInterface').style.display = 'flex';
            applyChatWallpaper();
            if (chatUnsubscribe) chatUnsubscribe();

            if (isCeleb) {
                currentChatId = 'celeb_' + name.replace(/[^a-zA-Z0-9]/g, '_');
                currentChatPartner = { name, avatar, isCeleb: true, partnerId: name };
                document.getElementById('callButtons').style.display = 'none';
            } else {
                currentChatId = [currentUser.uid, uid].sort().join('_');
                currentChatPartner = { name, avatar, uid, isCeleb: false, partnerId: uid };
                document.getElementById('callButtons').style.display = 'flex';
                document.getElementById('audioCallBtn').onclick = () => startCall('audio', uid, name, avatar);
                document.getElementById('videoCallBtn').onclick = () => startCall('video', uid, name, avatar);
            }

            setDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), {
                partnerName: name,
                partnerAvatar: avatar,
                partnerId: isCeleb ? name : uid,
                isCeleb: isCeleb,
                lastTimestamp: Date.now(),
            }, { merge: true }).catch(err => console.error('Error creating recent chat:', err));

            updateDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), { unreadCount: 0 }).catch(() => { });

            const q = query(collection(db, 'chats', currentChatId, 'messages'), orderBy('timestamp'));
            chatUnsubscribe = onSnapshot(q, (snap) => {
                const cont = document.getElementById('messageContainer');
                cont.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isSent = m.sender === currentUser.uid;
                    return `<div class="message ${isSent ? 'sent' : 'received'}">${m.text}<span class="message-time">${formatTimeAgo(m.timestamp)}</span></div>`;
                }).join('');
                cont.scrollTop = cont.scrollHeight;
            });
        }

        // ========== SEND MESSAGE ==========
        window.sendMessage = async function() {
            const inp = document.getElementById('msgInput');
            if (!inp.value.trim() || !currentChatId) return;
            const txt = inp.value.trim();

            await addDoc(collection(db, 'chats', currentChatId, 'messages'), {
                sender: currentUser.uid,
                text: txt,
                timestamp: serverTimestamp()
            });

            await setDoc(doc(db, 'userChats', currentUser.uid, 'chats', currentChatId), {
                partnerName: currentChatPartner.name,
                partnerAvatar: currentChatPartner.avatar,
                partnerId: currentChatPartner.isCeleb ? currentChatPartner.name : currentChatPartner.uid,
                isCeleb: currentChatPartner.isCeleb,
                lastMessage: txt,
                lastTimestamp: Date.now(),
                unreadCount: 0
            }, { merge: true });

            if (!currentChatPartner.isCeleb && currentChatPartner.uid) {
                const otherChatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
                await setDoc(doc(db, 'userChats', currentChatPartner.uid, 'chats', otherChatId), {
                    partnerName: currentUserData.fullName,
                    partnerAvatar: currentUserData.avatar,
                    partnerId: currentUser.uid,
                    isCeleb: false,
                    lastMessage: txt,
                    lastTimestamp: Date.now(),
                    unreadCount: increment(1)
                }, { merge: true });

                await addDoc(collection(db, 'notifications'), {
                    userId: currentChatPartner.uid,
                    type: 'message',
                    title: 'New Message',
                    message: txt,
                    from: currentUserData?.fullName || 'Someone',
                    avatar: currentUserData?.avatar || defaultAvatar,
                    timestamp: serverTimestamp(),
                    read: false,
                    link: `user|${currentUserData?.fullName || 'User'}|${currentUserData?.avatar || defaultAvatar}|${currentUser.uid}`
                });
            }

            if (currentChatPartner.isCeleb) {
                // Store in adminMessages for admin panel
                await addDoc(collection(db, 'adminMessages'), {
                    userId: currentUser.uid,
                    userName: currentUserData?.fullName || 'User',
                    userAvatar: currentUserData?.avatar || defaultAvatar,
                    celebrity: currentChatPartner.name,
                    message: txt,
                    timestamp: serverTimestamp(),
                    read: false,
                    fromAdmin: false
                });
            }

            inp.value = '';
            inp.blur();
        };

        window.closeChat = function() {
            document.getElementById('chatInterface').style.display = 'none';
            if (chatUnsubscribe) chatUnsubscribe();
            currentChatId = null;
            currentChatPartner = null;
            const video = document.getElementById('chatVideo');
            if (video) video.pause();
        };

        // ========== MARKETPLACE PRODUCTS ==========
        function loadProducts() {
            const q = query(collection(db, 'products'));
            onSnapshot(q, (snap) => {
                products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderMarketplace();
            });
        }

        function renderMarketplace() {
            const grid = document.getElementById('productsGrid');
            if (!grid) return;
            if (products.length === 0) {
                grid.innerHTML = '<div class="card">No products available yet.</div>';
                return;
            }
            grid.innerHTML = products.map(p => `
                <div class="product-card">
                    <div class="product-img"><i class="fas fa-${p.icon || 'box'}"></i></div>
                    <div class="product-info">
                        <div class="product-title">${p.name}</div>
                        <div class="product-price">$${p.price}</div>
                        <button class="btn-buy" onclick="openBuyModal('${p.name}', ${p.price})">Buy Now</button>
                    </div>
                </div>
            `).join('');
        }

        // ========== ADMIN PANEL FUNCTIONS ==========
        let adminSections = {
            dashboard: document.getElementById('adminDashboard'),
            users: document.getElementById('adminUsers'),
            posts: document.getElementById('adminPosts'),
            celebs: document.getElementById('adminCelebs'),
            products: document.getElementById('adminProducts'),
            fanchats: document.getElementById('adminFanChats'),
            settings: document.getElementById('adminSettings')
        };

        window.showAdminSection = (section) => {
            Object.values(adminSections).forEach(s => s.style.display = 'none');
            if (section === 'dashboard') adminSections.dashboard.style.display = 'block';
            else if (section === 'users') adminSections.users.style.display = 'block';
            else if (section === 'posts') adminSections.posts.style.display = 'block';
            else if (section === 'celebs') adminSections.celebs.style.display = 'block';
            else if (section === 'products') adminSections.products.style.display = 'block';
            else if (section === 'fanchats') adminSections.fanchats.style.display = 'block';
            else if (section === 'settings') adminSections.settings.style.display = 'block';
        };

        // Load admin data
        function loadAdminData() {
            // Users
            const usersQuery = query(collection(db, 'users'));
            onSnapshot(usersQuery, (snap) => {
                users = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statUsers').innerText = users.length;
                filterAdminUsers();
            });

            // Posts
            const postsQuery = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
            onSnapshot(postsQuery, (snap) => {
                posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statPosts').innerText = posts.length;
                renderAdminPosts();
            });

            // Celebrities
            const celebsQuery = query(collection(db, 'celebrities'));
            onSnapshot(celebsQuery, (snap) => {
                celebs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statCelebs').innerText = celebs.length;
                renderAdminCelebs();
            });

            // Products
            const productsQuery = query(collection(db, 'products'));
            onSnapshot(productsQuery, (snap) => {
                products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                document.getElementById('statProducts').innerText = products.length;
                renderAdminProducts();
                renderMarketplace(); // also update marketplace
            });

            // Fan messages
            const fanQuery = query(collection(db, 'adminMessages'), orderBy('timestamp', 'desc'));
            onSnapshot(fanQuery, (snap) => {
                fanMessages = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFanChats();
            });

            // Music URL
            getDoc(doc(db, 'settings', 'music')).then((docSnap) => {
                if (docSnap.exists()) {
                    document.getElementById('musicUrl').value = docSnap.data().url || '';
                }
            });
        }

        // Admin users list
        function filterAdminUsers() {
            const search = document.getElementById('adminSearchUsers').value.toLowerCase();
            const filtered = users.filter(u => u.fullName?.toLowerCase().includes(search) || u.email?.toLowerCase().includes(search));
            renderAdminUsers(filtered);
        }

        function renderAdminUsers(userList) {
            const container = document.getElementById('adminUsersList');
            if (!container) return;
            container.innerHTML = userList.map(u => `
                <div class="admin-card ${u.blocked ? 'blocked' : ''}">
                    <img src="${u.avatar || defaultAvatar}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <div><strong>${u.fullName}</strong> <span class="badge">VIP ${u.vipLevel}</span></div>
                    <div style="font-size:0.8rem; color:#aaa;">${u.email}</div>
                    <div class="admin-actions">
                        <button class="btn-small btn-primary-small" onclick="adminChangeVIP('${u.id}', ${u.vipLevel})">VIP</button>
                        <button class="btn-small btn-danger-small" onclick="adminDeleteUser('${u.id}')">Delete</button>
                        <button class="btn-small btn-primary-small" onclick="adminNotifyUser('${u.id}', '${u.fullName}')">Notify</button>
                        <button class="btn-small btn-warning-small" onclick="adminToggleBlock('${u.id}', ${u.blocked})">${u.blocked ? 'Unblock' : 'Block'}</button>
                    </div>
                </div>
            `).join('');
        }

        window.adminChangeVIP = async (userId, current) => {
            const newVIP = prompt(`Enter new VIP level (current: ${current}):`);
            if (newVIP && !isNaN(newVIP) && newVIP >= 1) {
                await updateDoc(doc(db, 'users', userId), { vipLevel: parseInt(newVIP) });
                Toastify({ text: "VIP updated", backgroundColor: "green" }).showToast();
            }
        };

        window.adminDeleteUser = async (userId) => {
            if (confirm('Delete this user? This cannot be undone.')) {
                await deleteDoc(doc(db, 'users', userId));
                Toastify({ text: "User deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.adminToggleBlock = async (userId, currentlyBlocked) => {
            await updateDoc(doc(db, 'users', userId), { blocked: !currentlyBlocked });
            Toastify({ text: `User ${currentlyBlocked ? 'unblocked' : 'blocked'}`, backgroundColor: "green" }).showToast();
        };

        document.getElementById('adminSearchUsers').addEventListener('input', filterAdminUsers);

        // Admin posts
        function renderAdminPosts() {
            const container = document.getElementById('adminPostsList');
            if (!container) return;
            container.innerHTML = posts.map(p => `
                <div class="admin-card">
                    <div><strong>${p.userName}</strong></div>
                    <div style="font-size:0.8rem;">${p.caption?.substring(0,50)}${p.caption?.length > 50 ? '...' : ''}</div>
                    <div class="admin-actions">
                        <button class="btn-small btn-danger-small" onclick="adminDeletePost('${p.id}')">Delete</button>
                        <button class="btn-small btn-warning-small" onclick="adminBlockUser('${p.userId}')">Block User</button>
                    </div>
                </div>
            `).join('');
        }

        window.adminDeletePost = async (postId) => {
            if (confirm('Delete this post?')) {
                await deleteDoc(doc(db, 'posts', postId));
                Toastify({ text: "Post deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.adminBlockUser = async (userId) => {
            await updateDoc(doc(db, 'users', userId), { blocked: true });
            Toastify({ text: "User blocked", backgroundColor: "green" }).showToast();
        };

        // Admin celebrities
        function renderAdminCelebs() {
            const container = document.getElementById('adminCelebsList');
            if (!container) return;
            container.innerHTML = celebs.map(c => `
                <div class="admin-card">
                    <img src="${c.img}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <div><strong>${c.name}</strong></div>
                    <div class="admin-actions">
                        <button class="btn-small btn-primary-small" onclick="openFanChatAsCeleb('${c.name}', '${c.img}')">Chat as</button>
                        <button class="btn-small btn-danger-small" onclick="adminDeleteCeleb('${c.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.adminAddCelebrity = async () => {
            const name = document.getElementById('adminCelebName').value.trim();
            const img = document.getElementById('adminCelebImg').value.trim();
            if (!name || !img) return Toastify({ text: "Enter name and image URL" }).showToast();
            await addDoc(collection(db, 'celebrities'), { name, img });
            document.getElementById('adminCelebName').value = '';
            document.getElementById('adminCelebImg').value = '';
            Toastify({ text: "Celebrity added", backgroundColor: "green" }).showToast();
        };

        window.adminDeleteCeleb = async (celebId) => {
            if (confirm('Delete this celebrity?')) {
                await deleteDoc(doc(db, 'celebrities', celebId));
                Toastify({ text: "Celebrity deleted", backgroundColor: "green" }).showToast();
            }
        };

        // Admin products
        function renderAdminProducts() {
            const container = document.getElementById('adminProductsList');
            if (!container) return;
            container.innerHTML = products.map(p => `
                <div class="admin-card">
                    <div><strong>${p.name}</strong> - $${p.price}</div>
                    <div class="admin-actions">
                        <button class="btn-small btn-primary-small" onclick="adminEditProduct('${p.id}', '${p.name}', ${p.price}, '${p.icon || 'box'}')">Edit</button>
                        <button class="btn-small btn-danger-small" onclick="adminDeleteProduct('${p.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        window.adminAddProduct = async () => {
            const name = document.getElementById('adminProductName').value.trim();
            const price = parseFloat(document.getElementById('adminProductPrice').value);
            const icon = document.getElementById('adminProductIcon').value.trim() || 'box';
            if (!name || isNaN(price)) return Toastify({ text: "Enter valid name and price" }).showToast();
            await addDoc(collection(db, 'products'), { name, price, icon });
            document.getElementById('adminProductName').value = '';
            document.getElementById('adminProductPrice').value = '';
            document.getElementById('adminProductIcon').value = 'box';
            Toastify({ text: "Product added", backgroundColor: "green" }).showToast();
        };

        window.adminDeleteProduct = async (productId) => {
            if (confirm('Delete this product?')) {
                await deleteDoc(doc(db, 'products', productId));
                Toastify({ text: "Product deleted", backgroundColor: "green" }).showToast();
            }
        };

        window.adminEditProduct = async (id, oldName, oldPrice, oldIcon) => {
            const name = prompt("Product name:", oldName);
            if (name === null) return;
            const price = parseFloat(prompt("Price:", oldPrice));
            if (isNaN(price)) return;
            const icon = prompt("Icon (Font Awesome name):", oldIcon) || 'box';
            await updateDoc(doc(db, 'products', id), { name, price, icon });
            Toastify({ text: "Product updated", backgroundColor: "green" }).showToast();
        };

        // Fan chats
        function renderFanChats() {
            const container = document.getElementById('fanChatsContainer');
            if (!container) return;

            const celebMap = new Map(); // celebName -> { avatar, users: { userId, userName, userAvatar, lastMessage, lastTime, fromAdmin } }

            fanMessages.forEach(msg => {
                const celebName = msg.celebrity;
                const userId = msg.userId;
                const userName = msg.userName || 'Unknown';
                const userAvatar = msg.userAvatar || defaultAvatar;
                const text = msg.message;
                const time = msg.timestamp?.toDate?.() || new Date();
                const fromAdmin = msg.fromAdmin || false;

                if (!celebMap.has(celebName)) {
                    const celeb = celebs.find(c => c.name === celebName);
                    celebMap.set(celebName, {
                        avatar: celeb ? celeb.img : defaultAvatar,
                        users: new Map()
                    });
                }
                const celebData = celebMap.get(celebName);
                if (!celebData.users.has(userId)) {
                    const user = users.find(u => u.id === userId);
                    celebData.users.set(userId, {
                        userId,
                        userName,
                        userAvatar,
                        vip: user?.vipLevel || 1,
                        lastMessage: text,
                        lastTime: time,
                        fromAdmin
                    });
                } else {
                    const existing = celebData.users.get(userId);
                    if (time > existing.lastTime) {
                        existing.lastMessage = text;
                        existing.lastTime = time;
                        existing.fromAdmin = fromAdmin;
                    }
                }
            });

            let html = '';
            for (let [celebName, celebData] of celebMap.entries()) {
                const usersList = Array.from(celebData.users.values()).sort((a,b) => b.lastTime - a.lastTime);
                html += `
                    <div class="celeb-group">
                        <div class="celeb-header" onclick="toggleCelebGroup(this)">
                            <img src="${celebData.avatar}" onerror="this.src='${defaultAvatar}'">
                            <span>${celebName}</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="user-conversations">
                `;
                usersList.forEach(u => {
                    const timeStr = formatTimeAgo(u.lastTime);
                    html += `
                        <div class="fan-card">
                            <img src="${u.userAvatar}" onerror="this.src='${defaultAvatar}'">
                            <div class="fan-info">
                                <div class="name">${u.userName} <span class="badge">VIP ${u.vip}</span></div>
                                <div class="last-msg">${u.fromAdmin ? 'ðŸ‘‘ You: ' : ''}${u.lastMessage}</div>
                                <div class="time">${timeStr}</div>
                            </div>
                            <button class="btn-small btn-primary-small" onclick="openFullScreenFanChat('${celebName}', '${celebData.avatar}', '${u.userId}', '${u.userName}', '${u.userAvatar}')">Chat</button>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            if (html === '') {
                html = '<p style="color:#aaa; text-align:center;">No fan conversations yet.</p>';
            }
            container.innerHTML = html;
        }

        window.toggleCelebGroup = (header) => {
            header.classList.toggle('collapsed');
            const content = header.nextElementSibling;
            if (content.style.display === 'none') {
                content.style.display = 'block';
            } else {
                content.style.display = 'none';
            }
        };

        // Full-screen fan chat
        window.openFullScreenFanChat = (celebName, celebAvatar, userId, userName, userAvatar) => {
            // Store current chat info
            window.currentAdminChatUserId = userId;
            window.currentAdminChatCeleb = { name: celebName, avatar: celebAvatar };
            window.currentAdminChatUserData = { name: userName, avatar: userAvatar };
            document.getElementById('adminChatAvatar').src = userAvatar;
            document.getElementById('adminChatTitle').innerText = `Chat with ${userName} (as ${celebName})`;
            document.getElementById('adminChatWindow').style.display = 'flex';
            loadFullScreenChatMessages(userId, celebName);
        };

        function loadFullScreenChatMessages(userId, celebName) {
            const chatId = [auth.currentUser.uid, userId].sort().join('_');
            const messagesRef = collection(db, 'chats', chatId, 'messages');
            if (window.adminChatUnsubscribe) window.adminChatUnsubscribe();
            window.adminChatUnsubscribe = onSnapshot(query(messagesRef, orderBy('timestamp')), (snap) => {
                const container = document.getElementById('adminChatMessages');
                container.innerHTML = snap.docs.map(d => {
                    const m = d.data();
                    const isSent = m.sender === auth.currentUser.uid;
                    return `<div class="admin-chat-message ${isSent ? 'sent' : 'received'}">${m.text}</div>`;
                }).join('');
                container.scrollTop = container.scrollHeight;
            });
        }

        window.sendAdminChatMessage = async () => {
            const input = document.getElementById('adminChatInput');
            const text = input.value.trim();
            if (!text || !window.currentAdminChatUserId) return;
            const chatId = [auth.currentUser.uid, window.currentAdminChatUserId].sort().join('_');

            await addDoc(collection(db, 'chats', chatId, 'messages'), {
                sender: auth.currentUser.uid,
                text: text,
                timestamp: serverTimestamp()
            });

            await setDoc(doc(db, 'userChats', window.currentAdminChatUserId, 'chats', chatId), {
                partnerName: window.currentAdminChatCeleb.name,
                partnerAvatar: window.currentAdminChatCeleb.avatar,
                partnerId: auth.currentUser.uid,
                isCeleb: true,
                lastMessage: text,
                lastTimestamp: Date.now(),
                unreadCount: increment(1)
            }, { merge: true });

            await addDoc(collection(db, 'adminMessages'), {
                userId: window.currentAdminChatUserId,
                userName: window.currentAdminChatUserData.name,
                userAvatar: window.currentAdminChatUserData.avatar,
                celebrity: window.currentAdminChatCeleb.name,
                message: text,
                timestamp: serverTimestamp(),
                read: true,
                fromAdmin: true
            });

            input.value = '';
        };

        window.closeAdminChatWindow = () => {
            document.getElementById('adminChatWindow').style.display = 'none';
            if (window.adminChatUnsubscribe) window.adminChatUnsubscribe();
            window.currentAdminChatUserId = null;
            window.currentAdminChatCeleb = null;
            window.currentAdminChatUserData = null;
        };

        // Admin notifications
        document.getElementById('notifyTarget').addEventListener('change', (e) => {
            document.getElementById('notifyUserId').style.display = e.target.value === 'user' ? 'block' : 'none';
        });

        window.sendNotification = async () => {
            const target = document.getElementById('notifyTarget').value;
            const userId = document.getElementById('notifyUserId').value;
            const title = document.getElementById('notifyTitle').value.trim();
            const message = document.getElementById('notifyMessage').value.trim();
            const link = document.getElementById('notifyLink').value.trim();
            if (!title || !message) return Toastify({ text: "Fill title and message" }).showToast();

            const notification = {
                type: 'admin',
                title,
                message,
                from: 'System',
                avatar: defaultAvatar,
                timestamp: serverTimestamp(),
                read: false,
                link: link || ''
            };

            if (target === 'all') {
                const usersSnap = await getDocs(collection(db, 'users'));
                const batch = writeBatch(db);
                usersSnap.forEach(docSnap => {
                    const notifRef = doc(collection(db, 'notifications'));
                    batch.set(notifRef, { ...notification, userId: docSnap.id });
                });
                await batch.commit();
                Toastify({ text: "Notifications sent to all users", backgroundColor: "green" }).showToast();
            } else {
                if (!userId) return Toastify({ text: "Enter user ID" }).showToast();
                await addDoc(collection(db, 'notifications'), { ...notification, userId });
                Toastify({ text: "Notification sent", backgroundColor: "green" }).showToast();
            }
        };

        window.adminNotifyUser = (userId, userName) => {
            document.getElementById('notifyTarget').value = 'user';
            document.getElementById('notifyUserId').value = userId;
            document.getElementById('notifyUserId').style.display = 'block';
            document.getElementById('notifyTitle').focus();
            Toastify({ text: `Now sending notification to ${userName}`, backgroundColor: "green" }).showToast();
            // Switch to settings section
            showAdminSection('settings');
        };

        // Global music
        window.setMusicUrl = async () => {
            const url = document.getElementById('musicUrl').value.trim();
            await setDoc(doc(db, 'settings', 'music'), { url });
            Toastify({ text: "Music URL updated", backgroundColor: "green" }).showToast();
        };

        // ========== MARKETPLACE BUY ==========
        window.openBuyModal = (name, price) => {
            selectedProduct = { name, price };
            document.getElementById('buyProductName').innerText = name + ' - $' + price;
            document.getElementById('buyModal').style.display = 'flex';
        };
        window.processPurchase = async () => {
            const addr = document.getElementById('shipAddress').value;
            const phone = document.getElementById('shipPhone').value;
            if (!addr || !phone) return Toastify({ text: "Fill all fields" }).showToast();
            if (currentUserData.balance < selectedProduct.price) { Toastify({ text: "Insufficient funds" }).showToast(); return; }
            document.getElementById('buyModal').style.display = 'none';
            document.getElementById('spinner').style.display = 'flex';
            const track = 'TRK-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-selectedProduct.price) });
            currentUserData.balance -= selectedProduct.price;
            updateBalanceDisplay();
            await addDoc(collection(db, 'orders'), {
                userId: currentUser.uid,
                product: selectedProduct.name,
                price: selectedProduct.price,
                address: addr,
                phone,
                trackingCode: track,
                status: 'Processing'
            });
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('finalTrackingCode').innerText = track;
            document.getElementById('successModal').style.display = 'flex';
        };

        window.attemptWithdrawal = () => {
            if ((currentUserData.vipLevel || 1) < 4) { Toastify({ text: "VIP 4 required" }).showToast(); return; }
            document.getElementById('withdrawModal').style.display = 'flex';
        };
        window.submitWithdrawal = async () => {
            const amt = parseFloat(document.getElementById('withdrawAmount').value);
            const addr = document.getElementById('withdrawAddress').value;
            if (!amt || amt < 1 || !addr) return Toastify({ text: "Invalid amount or address" }).showToast();
            if (amt > currentUserData.balance) return Toastify({ text: "Insufficient balance" }).showToast();
            await updateDoc(doc(db, 'users', currentUser.uid), { balance: increment(-amt) });
            currentUserData.balance -= amt;
            updateBalanceDisplay();
            await addDoc(collection(db, 'withdrawals'), { userId: currentUser.uid, amount: amt, address: addr, timestamp: Date.now() });
            document.getElementById('withdrawModal').style.display = 'none';
            Toastify({ text: "Withdrawal requested" }).showToast();
        };

        window.openDepositModal = () => document.getElementById('depositModal').style.display = 'flex';
        window.copyAddress = () => {
            navigator.clipboard.writeText('bc1qm3mfz4ytpkthcdcl0fep3ndzq2g3jxme4de05p');
            Toastify({ text: "Address copied" }).showToast();
        };

        // ========== AVATAR UPLOAD ==========
        window.openAvatarModal = () => document.getElementById('avatarModal').style.display = 'flex';
        window.uploadAvatar = async () => {
            const file = document.getElementById('avatarFileInput').files[0];
            if (!file) return Toastify({ text: "Select an image" }).showToast();
            const status = document.getElementById('avatarUploadStatus');
            status.innerText = 'Uploading...';
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: formData });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message);
                await updateDoc(doc(db, 'users', currentUser.uid), { avatar: data.secure_url });
                currentUserData.avatar = data.secure_url;
                document.getElementById('profileAvatar').src = data.secure_url;
                document.getElementById('avatarModal').style.display = 'none';
                Toastify({ text: "Avatar updated" }).showToast();
            } catch (e) {
                console.error("Avatar upload error:", e);
                status.innerText = 'Error: ' + e.message;
            }
        };

        window.openGiftStore = () => {
            document.getElementById('giftStoreModal').style.display = 'flex';
        };

        window.navTo = (page, el) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(page).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');

            // Show/hide floating support button
            const supportBtn = document.getElementById('supportChatFloat');
            if (page === 'profile') {
                supportBtn.style.display = 'flex';
            } else {
                supportBtn.style.display = 'none';
            }

            // Manage posts listener
            if (page === 'posts') {
                loadPosts();
            } else {
                if (postsUnsubscribe) {
                    postsUnsubscribe();
                    postsUnsubscribe = null;
                }
            }
        };

        // ========== POSTS ==========
        const uploadPostBtn = document.getElementById('uploadPostBtn');
        const postUploadModal = document.getElementById('postUploadModal');
        const postCaption = document.getElementById('postCaption');
        const postFile = document.getElementById('postFile');
        const postUploadStatus = document.getElementById('postUploadStatus');
        const postsFeed = document.getElementById('postsFeed');

        async function checkUploadLimit() {
            if (!currentUserData) return { allowed: false, reason: 'Not logged in' };
            const vip = currentUserData.vipLevel || 1;
            if (vip >= 4) return { allowed: true, unlimited: true };
            const today = new Date().toDateString();
            const lastUpload = currentUserData.lastUploadDate || '';
            const count = currentUserData.uploadCount || 0;
            if (lastUpload !== today) {
                return { allowed: true, count: 0 };
            }
            if (count >= 2) {
                return { allowed: false, reason: 'Daily limit reached (max 2). Upgrade to VIP 4 for unlimited.' };
            }
            return { allowed: true, count };
        }

        async function updateUploadButton() {
            const limit = await checkUploadLimit();
            if (limit.allowed) {
                uploadPostBtn.classList.remove('limited');
                uploadPostBtn.disabled = false;
            } else {
                uploadPostBtn.classList.add('limited');
                uploadPostBtn.disabled = true;
            }
        }

        uploadPostBtn.addEventListener('click', async () => {
            const limit = await checkUploadLimit();
            if (!limit.allowed) {
                Toastify({ text: limit.reason, backgroundColor: '#e74c3c' }).showToast();
                return;
            }
            postUploadModal.style.display = 'flex';
            postCaption.value = '';
            postFile.value = '';
            postUploadStatus.textContent = '';
        });

        window.uploadPost = async function() {
            const file = postFile.files[0];
            const caption = postCaption.value.trim();
            if (!file) {
                postUploadStatus.textContent = 'Please select a file';
                return;
            }
            if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                postUploadStatus.textContent = 'Only images and videos allowed';
                return;
            }
            postUploadStatus.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/auto/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error?.message || 'Upload failed');

                const mediaUrl = data.secure_url;
                const mediaType = file.type.startsWith('image/') ? 'image' : 'video';

                const today = new Date().toDateString();
                const vip = currentUserData.vipLevel || 1;
                let newCount = 1;
                if (vip < 4) {
                    const lastDate = currentUserData.lastUploadDate;
                    const oldCount = currentUserData.uploadCount || 0;
                    if (lastDate === today) {
                        newCount = oldCount + 1;
                    } else {
                        newCount = 1;
                    }
                    await updateDoc(doc(db, 'users', currentUser.uid), {
                        lastUploadDate: today,
                        uploadCount: newCount
                    });
                    currentUserData.lastUploadDate = today;
                    currentUserData.uploadCount = newCount;
                }

                await addDoc(collection(db, 'posts'), {
                    userId: currentUser.uid,
                    userName: currentUserData.fullName || 'User',
                    userAvatar: currentUserData.avatar || defaultAvatar,
                    mediaUrl,
                    mediaType,
                    caption,
                    timestamp: serverTimestamp(),
                    likes: []
                });

                postUploadModal.style.display = 'none';
                Toastify({ text: 'Post published!', backgroundColor: 'green' }).showToast();
                updateUploadButton();
            } catch (e) {
                console.error("Post upload error:", e);
                postUploadStatus.textContent = 'Error: ' + e.message;
            }
        };

        // ===== Comments =====
        async function loadComments(postId) {
            if (commentUnsubscribes.has(postId)) {
                commentUnsubscribes.get(postId)();
            }
            const commentsRef = collection(db, 'posts', postId, 'comments');
            const q = query(commentsRef, orderBy('timestamp', 'asc'));
            const unsubscribe = onSnapshot(q, (snap) => {
                const comments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderComments(postId, comments);
            }, (error) => {
                console.error('Comments listener error:', error);
            });
            commentUnsubscribes.set(postId, unsubscribe);
        }

        function renderComments(postId, comments) {
            const commentList = document.getElementById(`comments-${postId}`);
            if (!commentList) return;
            commentList.innerHTML = comments.map(c => {
                const time = c.timestamp ? formatTimeAgo(c.timestamp) : '';
                return `
                    <div class="comment-item">
                        <img src="${c.userAvatar || defaultAvatar}" class="comment-avatar" onerror="this.src='${defaultAvatar}'">
                        <div class="comment-content">
                            <div class="comment-author">${c.userName || 'User'}</div>
                            <div class="comment-text">${c.text}</div>
                            <div class="comment-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleComments = function(postId) {
            const section = document.getElementById(`comment-section-${postId}`);
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                loadComments(postId);
            } else {
                section.style.display = 'none';
                if (commentUnsubscribes.has(postId)) {
                    commentUnsubscribes.get(postId)();
                    commentUnsubscribes.delete(postId);
                }
            }
        };

        window.postComment = async function(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            const commentsRef = collection(db, 'posts', postId, 'comments');
            await addDoc(commentsRef, {
                userId: currentUser.uid,
                userName: currentUserData.fullName || 'User',
                userAvatar: currentUserData.avatar || defaultAvatar,
                text,
                timestamp: serverTimestamp()
            });
            input.value = '';
        };

        // ===== Posts feed =====
        function loadPosts() {
            if (postsUnsubscribe) postsUnsubscribe();
            const q = query(collection(db, 'posts'), orderBy('timestamp', 'desc'));
            postsUnsubscribe = onSnapshot(q, async (snap) => {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;

                const deletePromises = [];
                snap.docs.forEach(docSnap => {
                    const post = docSnap.data();
                    if (post.timestamp && (now - post.timestamp.toDate()) > oneDay) {
                        deletePromises.push(deleteDoc(docSnap.ref));
                    }
                });
                await Promise.all(deletePromises);

                const freshSnap = await getDocs(q);
                const posts = freshSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(posts);
            }, (error) => {
                console.error('Posts listener error:', error);
            });
        }

        function renderPosts(posts) {
            if (!postsFeed) return;
            if (posts.length === 0) {
                postsFeed.innerHTML = '<div class="notification-empty">No posts yet</div>';
                return;
            }
            postsFeed.innerHTML = posts.map(p => {
                const isLiked = p.likes?.includes(currentUser.uid);
                const likeCount = p.likes?.length || 0;
                const time = p.timestamp ? formatTimeAgo(p.timestamp) : '';
                return `
                    <div class="post-card" data-post-id="${p.id}">
                        <div class="post-header">
                            <img src="${p.userAvatar}" class="post-avatar" onerror="this.src='${defaultAvatar}'">
                            <div class="post-info">
                                <div class="post-name">${p.userName}</div>
                                <div class="post-time">${time}</div>
                            </div>
                        </div>
                        ${p.mediaType === 'image'
                            ? `<img src="${p.mediaUrl}" class="post-media" loading="lazy">`
                            : `<video src="${p.mediaUrl}" class="post-media" controls loop muted playsinline></video>`
                        }
                        ${p.caption ? `<div class="post-caption">${p.caption}</div>` : ''}
                        <div class="post-actions">
                            <div class="post-like ${isLiked ? 'liked' : ''}" onclick="toggleLike('${p.id}')">
                                <i class="fas fa-heart"></i>
                                <span>${likeCount}</span>
                            </div>
                            <div class="post-comment" onclick="toggleComments('${p.id}')">
                                <i class="fas fa-comment"></i>
                                <span>Comment</span>
                            </div>
                        </div>
                        <div id="comment-section-${p.id}" class="comment-section" style="display: none;">
                            <div id="comments-${p.id}" class="comment-list"></div>
                            <div class="comment-input-area">
                                <input type="text" id="comment-input-${p.id}" class="comment-input" placeholder="Write a comment...">
                                <button class="comment-send" onclick="postComment('${p.id}')"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.toggleLike = async function(postId) {
            if (!currentUser) return;
            const postRef = doc(db, 'posts', postId);
            const postSnap = await getDoc(postRef);
            if (!postSnap.exists()) return;
            const likes = postSnap.data().likes || [];
            if (likes.includes(currentUser.uid)) {
                await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
            }
        };

        // ========== SEARCH ==========
        document.getElementById('searchCelebs')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#allCelebGrid .celeb-card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'block' : 'none';
            });
        });

        document.getElementById('searchUsers')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#userList .celeb-card').forEach(c => {
                c.style.display = c.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        });

        // ========== ADMIN CHAT SUPPORT BUTTON ==========
        window.openAdminChat = async function() {
            if (!currentUser) return;
            if (adminUserData) {
                openUserChat(adminUserData.fullName, adminUserData.avatar, adminUserData.uid);
                return;
            }
            try {
                const q = query(collection(db, 'users'), where('email', '==', ADMIN_EMAIL));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    Toastify({ text: "Admin user not found", backgroundColor: "#e74c3c" }).showToast();
                    return;
                }
                const adminDoc = querySnapshot.docs[0];
                adminUserData = {
                    uid: adminDoc.id,
                    ...adminDoc.data()
                };
                openUserChat(adminUserData.fullName, adminUserData.avatar, adminUserData.uid);
            } catch (error) {
                console.error("Error fetching admin:", error);
                Toastify({ text: "Error opening admin chat", backgroundColor: "#e74c3c" }).showToast();
            }
        };

        // ========== AUTH STATE ==========
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log("User logged in:", user.email);
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                } else {
                    currentUserData = {
                        fullName: user.email.split('@')[0],
                        email: user.email,
                        balance: 0,
                        vipLevel: 1,
                        avatar: defaultAvatar,
                        wallpaper: 'static17',
                        uploadCount: 0,
                        lastUploadDate: ''
                    };
                    await setDoc(doc(db, 'users', user.uid), currentUserData);
                }
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                updateBalanceDisplay();
                document.getElementById('userVipLevel').innerText = currentUserData?.vipLevel ?? '1';
                document.getElementById('profileName').innerText = currentUserData?.fullName ?? 'User';
                document.getElementById('profileAvatar').src = currentUserData?.avatar ?? defaultAvatar;

                preloadWallpapers();
                await loadCelebrities();
                loadUsers();
                loadRecentChats();
                loadNotifications();
                loadProducts(); // load marketplace products
                updateUploadButton();

                document.getElementById('bellIcon').addEventListener('click', toggleNotificationDropdown);

                // Check if admin
                const isAdmin = (user.email === ADMIN_EMAIL);
                if (isAdmin) {
                    console.log("Admin detected, adding admin tab");
                    document.getElementById('adminCelebForm').style.display = 'block';
                    // Add admin nav item if not already present
                    const bottomNav = document.getElementById('bottomNav');
                    if (!document.querySelector('.nav-item[onclick*="admin"]')) {
                        const adminNav = document.createElement('div');
                        adminNav.className = 'nav-item';
                        adminNav.setAttribute('onclick', 'navTo(\'admin\', this)');
                        adminNav.innerHTML = '<i class="fas fa-crown"></i><span>Admin</span>';
                        bottomNav.appendChild(adminNav);
                    }
                    // Load admin data
                    loadAdminData();
                } else {
                    document.getElementById('adminCelebForm').style.display = 'none';
                }

                // Start listening for incoming calls
                listenForIncomingCalls();

                document.getElementById('supportChatFloat').style.display = 'none';
            } else {
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        // ========== CALL SYSTEM ==========
        let peerConnection = null;
        let localStream = null;
        let currentCallId = null;
        let incomingCallDoc = null;
        let unsubscribeCallListener = null;
        let unsubscribeOfferCandidates = null;
        let unsubscribeAnswerCandidates = null;

        const servers = {
            iceServers: [
                { urls: "stun:stun.l.google.com:19302" }
            ]
        };

        function showCallModal() {
            document.getElementById("callModal").style.display = "flex";
        }

        function hideCallModal() {
            document.getElementById("callModal").style.display = "none";
        }

        function updateCallUI(status, showAcceptReject = false, showEnd = false, avatarUrl = null) {
            if (avatarUrl) {
                document.getElementById('callAvatarImg').src = avatarUrl;
            }
            document.getElementById('callStatus').innerText = status;
            document.getElementById('acceptCallBtn').style.display = showAcceptReject ? 'inline-block' : 'none';
            document.getElementById('rejectCallBtn').style.display = showAcceptReject ? 'inline-block' : 'none';
            document.getElementById('endCallBtn').style.display = showEnd ? 'inline-block' : 'none';
            
            if (status === 'In call') {
                document.getElementById('localVideo').style.display = 'block';
                document.getElementById('remoteVideo').style.display = 'block';
                document.getElementById('callAvatarContainer').style.display = 'none';
            } else {
                document.getElementById('localVideo').style.display = 'none';
                document.getElementById('remoteVideo').style.display = 'none';
                document.getElementById('callAvatarContainer').style.display = 'block';
            }
        }

        async function requestMedia(type) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: type === 'video',
                    audio: true
                });
                return stream;
            } catch (error) {
                console.error("Media error:", error);
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    Toastify({ text: "Camera/Microphone access denied. Please allow permissions.", backgroundColor: "#e74c3c" }).showToast();
                } else if (error.name === 'NotFoundError') {
                    Toastify({ text: "No camera or microphone found.", backgroundColor: "#e74c3c" }).showToast();
                } else if (error.name === 'NotReadableError') {
                    Toastify({ text: "Camera or microphone already in use by another app.", backgroundColor: "#e74c3c" }).showToast();
                } else {
                    Toastify({ text: "Could not access media: " + error.message, backgroundColor: "#e74c3c" }).showToast();
                }
                throw error;
            }
        }

        async function cleanupCall(deleteFromFirestore = true) {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (unsubscribeCallListener) {
                unsubscribeCallListener();
                unsubscribeCallListener = null;
            }
            if (unsubscribeOfferCandidates) {
                unsubscribeOfferCandidates();
                unsubscribeOfferCandidates = null;
            }
            if (unsubscribeAnswerCandidates) {
                unsubscribeAnswerCandidates();
                unsubscribeAnswerCandidates = null;
            }
            if (currentCallId && deleteFromFirestore) {
                try {
                    const offerCandidatesSnap = await getDocs(collection(db, 'calls', currentCallId, 'offerCandidates'));
                    const batch = writeBatch(db);
                    offerCandidatesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    const answerCandidatesSnap = await getDocs(collection(db, 'calls', currentCallId, 'answerCandidates'));
                    answerCandidatesSnap.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await deleteDoc(doc(db, 'calls', currentCallId));
                } catch (e) {
                    console.error("Error deleting call documents:", e);
                }
                currentCallId = null;
            }
            hideCallModal();
        }

        window.endCall = cleanupCall;

        async function startCall(type, receiverId, partnerName, partnerAvatar) {
            if (!currentUser) return;
            if (currentUserData.vipLevel < 4) {
                Toastify({ text: "VIP 4 required for calls", backgroundColor: "#e74c3c" }).showToast();
                return;
            }

            try {
                localStream = await requestMedia(type);
            } catch {
                return;
            }

            peerConnection = new RTCPeerConnection(servers);
            peerConnection.ontrack = event => {
                document.getElementById("remoteVideo").srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            document.getElementById("localVideo").srcObject = localStream;

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            const callData = {
                callerId: currentUser.uid,
                receiverId: receiverId,
                type: type,
                status: 'calling',
                offer: JSON.stringify(offer),
                createdAt: serverTimestamp()
            };
            const callRef = await addDoc(collection(db, 'calls'), callData);
            currentCallId = callRef.id;

            unsubscribeCallListener = onSnapshot(doc(db, 'calls', currentCallId), async (snap) => {
                const data = snap.data();
                if (!data) return;
                if (data.answer && !peerConnection.currentRemoteDescription) {
                    const answer = new RTCSessionDescription(JSON.parse(data.answer));
                    await peerConnection.setRemoteDescription(answer);
                    updateCallUI('In call', false, true, partnerAvatar);
                }
                if (data.status === 'rejected' || data.status === 'ended') {
                    Toastify({ text: `Call ${data.status}`, backgroundColor: "#e74c3c" }).showToast();
                    cleanupCall(false);
                }
            });

            unsubscribeAnswerCandidates = onSnapshot(collection(db, 'calls', currentCallId, 'answerCandidates'), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    await addDoc(collection(db, 'calls', currentCallId, 'offerCandidates'), {
                        candidate: JSON.stringify(event.candidate)
                    });
                }
            };

            showCallModal();
            updateCallUI('Connecting...', false, true, partnerAvatar);
        }

        window.startCall = startCall;

        async function listenForIncomingCalls() {
            onSnapshot(query(
                collection(db, 'calls'),
                where('receiverId', '==', currentUser?.uid),
                where('status', '==', 'calling')
            ), async (snapshot) => {
                if (snapshot.empty) return;
                const callDoc = snapshot.docs[0];
                const data = callDoc.data();
                currentCallId = callDoc.id;
                incomingCallDoc = callDoc;

                const callerSnap = await getDoc(doc(db, 'users', data.callerId));
                const callerData = callerSnap.data();

                showCallModal();
                updateCallUI(`Incoming ${data.type} call from ${callerData?.fullName || 'User'}`, true, false, callerData?.avatar || defaultAvatar);

                document.getElementById('acceptCallBtn').onclick = () => acceptCall(callDoc, callerData);
                document.getElementById('rejectCallBtn').onclick = () => rejectCall(callDoc);
            });
        }

        async function acceptCall(callDoc, callerData) {
            try {
                localStream = await requestMedia(callDoc.data().type);
            } catch {
                return;
            }

            peerConnection = new RTCPeerConnection(servers);
            peerConnection.ontrack = event => {
                document.getElementById("remoteVideo").srcObject = event.streams[0];
            };

            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            document.getElementById("localVideo").srcObject = localStream;

            const offer = new RTCSessionDescription(JSON.parse(callDoc.data().offer));
            await peerConnection.setRemoteDescription(offer);

            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            await updateDoc(doc(db, 'calls', currentCallId), {
                answer: JSON.stringify(answer),
                status: 'accepted'
            });

            unsubscribeOfferCandidates = onSnapshot(collection(db, 'calls', currentCallId, 'offerCandidates'), snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                        peerConnection.addIceCandidate(candidate);
                    }
                });
            });

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate) {
                    await addDoc(collection(db, 'calls', currentCallId, 'answerCandidates'), {
                        candidate: JSON.stringify(event.candidate)
                    });
                }
            };

            unsubscribeCallListener = onSnapshot(doc(db, 'calls', currentCallId), (snap) => {
                const data = snap.data();
                if (data && data.status === 'ended') {
                    Toastify({ text: "Call ended", backgroundColor: "#e74c3c" }).showToast();
                    cleanupCall(false);
                }
            });

            updateCallUI('In call', false, true, callerData?.avatar);
        }

        async function rejectCall(callDoc) {
            await updateDoc(doc(db, 'calls', currentCallId), { status: 'rejected' });
            cleanupCall(true);
        }

        document.getElementById('endCallBtn').onclick = () => cleanupCall(true);
    </script>
</body>
</html>
